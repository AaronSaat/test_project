<?php

namespace app\controllers;

use Yii;
use yii\web\Controller;
use app\models\Accounts;
use app\models\Journal;
use app\models\Journalumum;
use app\models\Journaldetail;
use app\models\DetailCompare;
use app\models\JournalCompare;
use app\models\AccountCompare;
use yii\data\ActiveDataProvider;
use yii\web\UploadedFile;
use app\models\JsonUploadForm;

class ApiController extends Controller
{ 
    public function beforeAction($action) 
    { 
        $this->enableCsrfValidation = false; 
        return parent::beforeAction($action); 
    }

    public function actionIndex()
    {
        $query = Accounts::find();
        $dataProvider = new ActiveDataProvider([
            'query' => $query,
            'pagination' => [
                'pageSize' => 100, 
            ],
        ]);

        return $this->render('index', [
            'dataProvider' => $dataProvider,
        ]);
    }

    public function actionJournalIndex()
    {
        // // $query = JournalCompare::find();
        // $query = JournalCompare::find()->limit(100); 
        // ganti 51000
        $query = JournalCompare::find()->limit(20000);

        $dataProvider = new ActiveDataProvider([
            'query' => $query,
            'pagination' => [
                'pageSize' => 500,
                // 'pagination' => false,
            ],
        ]);

        return $this->render('journalindex', [
            'dataProvider' => $dataProvider,
        ]);
    }

    public function actionViewDetailJournalIndex($id)
    {
        $journalCompare = JournalCompare::findOne($id);
        $number = $journalCompare->number;

        $dataProvider = new ActiveDataProvider([
            'query' => DetailCompare::find()->where(['number' => $number]),
            // 'pagination' => [
            //     'pageSize' => 200, 
            // ],
        ]);

        return $this->render('viewdetailjournalindex', [
            'journalCompare' => $journalCompare,
            'dataProvider' => $dataProvider,
        ]);
    }


    public function actionJsonUploadIndex()
    {
        $model = new JsonUploadForm();

        if (Yii::$app->request->isPost) {
            $model->file = UploadedFile::getInstance($model, 'file');

            if ($model->validate()) {
                $uploadPath = Yii::getAlias('@webroot/uploads/');

                // Pastikan direktori tujuan ada, jika tidak buat baru
                if (!is_dir($uploadPath)) {
                    mkdir($uploadPath, 0777, true);
                }

                //hapus semua dulu lalu input ulang
                // AccountCompare::deleteAll();

                // Simpan file di direktori
                $filePath = $uploadPath . $model->file->name;
                if ($model->file->saveAs($filePath)) {
                    // Baca isi file JSON
                    $jsonData = file_get_contents($filePath);
                    $decodedData = json_decode($jsonData, true);
                    
                    if (isset($decodedData['GLACCNT'])) {
                        $filteredData = [];
                        foreach ($decodedData['GLACCNT'] as $item) {
                            if (isset($item['GLACCOUNT']) && isset($item['ACCOUNTNAME'])) {
                                $currencyCode = "";
                                $accountType = "";
                                if (isset($item['CURRENCYID'])) {
                                    $currencyCode = $item['CURRENCYID'] == 1 ? "IDR" : "";
                                }
                                if (isset($item['FIRSTPARENTACCOUNT'])) {
                                    $parentNo = $item['FIRSTPARENTACCOUNT'] ?? "";
                                }
                                if (isset($item['ACCOUNTTYPE'])) {
                                    switch ($item['ACCOUNTTYPE']) {
                                        case 7:
                                            $accountType = "ACCOUNT_PAYABLE";
                                            break;
                                        case 8:
                                            $accountType = "ACCOUNT_RECEIVABLE";
                                            break;
                                        case 9:
                                            $accountType = "ACCUMULATED_DEPRECIATION";
                                            break;
                                        case 10:
                                            $accountType = "CASH_BANK";
                                            break;
                                        case 11:
                                            $accountType = "COGS";
                                            break;
                                        case 12:
                                            $accountType = "EQUITY";
                                            break;
                                        case 13:
                                            $accountType = "EXPENSE";
                                            break;
                                        case 14:
                                            $accountType = "FIXED_ASSET";
                                            break;
                                        case 15:
                                            $accountType = "INVENTORY";
                                            break;
                                        case 16:
                                            $accountType = "LONG_TERM_LIABILITY";
                                            break;
                                        case 17:
                                            $accountType = "OTHER_ASSET";
                                            break;
                                        case 18:
                                            $accountType = "OTHER_CURRENT_ASSET";
                                            break;
                                        case 19:
                                            $accountType = "OTHER_CURRENT_LIABILITY";
                                            break;
                                        case 20:
                                            $accountType = "OTHER_EXPENSE";
                                            break;
                                        case 21:
                                            $accountType = "OTHER_INCOME";
                                            break;
                                        case 22:
                                            $accountType = "REVENUE";
                                            break;
                                        default:
                                            $accountType = "";  // Default 
                                            break;
                                    }
                                }

                                $filteredData[] = [
                                    'no' => $item['GLACCOUNT'],
                                    'asOf' => date('d/m/Y'), 
                                    'accountType' => $accountType,
                                    'currencyCode' => $currencyCode,
                                    'name' => $item['ACCOUNTNAME'],
                                    'memo' => $item['MEMO'],
                                    'parentNo' => $parentNo,
                                ];

                                $AccountCompare = new AccountCompare();
                                $AccountCompare->no = $item['GLACCOUNT'];
                                $AccountCompare->accountType = $accountType;
                                $AccountCompare->name =$item['ACCOUNTNAME'];
                                $AccountCompare->parentNo = $parentNo;
                                $AccountCompare->save();
                            }
                        }
                        
                        Yii::$app->session->set('importAccountFromJson', $filteredData);
                        // Render view untuk menampilkan tabel
                        Yii::$app->session->setFlash('success', "File berhasil diunggah ke: {$filePath}");
                        return $this->render('jsonuploadaccounttable', [
                            'filteredData' => $filteredData,
                        ]);
                    } else {
                        Yii::$app->session->setFlash('error', 'Key "GLACCNT" tidak ditemukan dalam file JSON.');
                    }
                } else {
                    Yii::$app->session->setFlash('error', 'Gagal menyimpan file.');
                }

                return $this->refresh();
            }
        }

        return $this->render('jsonuploadindex', [
            'model' => $model,
        ]);
    }

    //ini untuk proses lama, yang baru menggunakan function sendJournalApi
    public function actionJsonUploadJurnalIndex()
    {
        $model = new JsonUploadForm();

        if (Yii::$app->request->isPost) {
            $model->journalFile = UploadedFile::getInstance($model, 'journalFile');

            if ($model->validate()) {
                $uploadPath = Yii::getAlias('@webroot/uploads/');

                // Pastikan direktori tujuan ada, jika tidak buat baru
                if (!is_dir($uploadPath)) {
                    mkdir($uploadPath, 0777, true);
                }

                $journalFilePath = $uploadPath . $model->journalFile->name;

                //hapus semua dulu lalu input ulang
                // JournalCompare::deleteAll();
                // DetailCompare::deleteAll();

                if ($model->journalFile->saveAs($journalFilePath)) {
                    // Decode kedua file
                    $journalData = json_decode(file_get_contents($journalFilePath), true);  

                    if (isset($journalData['JV'])) {
                        $groupedJournals = [];
                    
                        foreach ($journalData['JV'] as $journal) {
                            $JVNUMBER = $journal['JVNUMBER'];
                    
                            if (!isset($groupedJournals[$JVNUMBER])) {
                                // Buat jurnal hanya sekali per JVNUMBER
                                $groupedJournals[$JVNUMBER] = [
                                    'number' => $JVNUMBER,
                                    'transDate' => date('d/m/Y', strtotime($journal['TRANSDATE'])),
                                    'description' => $journal['TRANSDESCRIPTION'],
                                    'branchName' => $journal['BRANCHCODE'],
                                    'journaldetail' => []
                                ];
                    
                                // Simpan di database JournalCompare
                                $journalCompare = new JournalCompare();
                                $journalCompare->number = $JVNUMBER;
                                $journalCompare->transDate = date('d/m/Y', strtotime($journal['TRANSDATE']));
                                $journalCompare->description = $journal['TRANSDESCRIPTION'];
                                $journalCompare->branchName = $journal['BRANCHCODE'];
                                $journalCompare->save();
                            }
                            
                            $accountMapping = [            
                                '1000' => '1-1000',
                                '1001' => '1-1001',
                                '1001.01' => '1-1001.01',
                                '1001.02' => '1-1001.02',
                                '1001.03' => '1-1001.03',
                                '1001.03.01' => '1-1001.03.01',
                                '1001.03.02' => '1-1001.03.02',
                                '1001.03.03' => '1-1001.03.03',
                                '1001.03.04' => '1-1001.03.04',
                                '1001.03.05' => '1-1001.03.05',
                                '1002' => '1-1002',
                                '1002.01' => '1-1002.01',
                                '1002.02' => '1-1002.02',
                                '1002.03' => '1-1002.03',
                                '1002.04' => '1-1002.04',
                                '1002.05' => '1-1002.05',
                                '1002.11' => '1-1002.11',
                                '1002.11.01' => '1-1002.11.01',
                                '1002.11.02' => '1-1002.11.02',
                                '1002.11.03' => '1-1002.11.03',
                                '1002.11.04' => '1-1002.11.04',
                                '1002.11.05' => '1-1002.11.05',
                                '1002.11.06' => '1-1002.11.06',
                                '1002.11.07' => '1-1002.11.07',
                                '1002.06' => '1-1002.06',
                                '1002.07' => '1-1002.07',
                                '1002.08' => '1-1002.08',
                                '1002.09' => '1-1002.09',
                                '1002.10' => '1-1002.10',
                                '1003' => '1-1003',
                                '1003.01' => '1-1003.01',
                                '1003.02' => '1-1003.02',
                                '1400' => '1-1400',
                                '1400.01' => '1-1400.01',
                                '1400.02' => '1-1400.02',
                                '1400.03' => '1-1400.03',
                                '1400.04' => '1-1400.04',
                                '1401' => '1-1401',
                                '1500' => '1-1500',
                                '1500.01' => '1-1500.01',
                                '1500.02' => '1-1500.02',
                                '1500.03' => '1-1500.03',
                                '1500.04' => '1-1500.04',
                                '1700' => '1-1700',
                                '1700.01' => '1-1700.01',
                                '1700.01.01' => '1-1700.01.01',
                                '1700.01.02' => '1-1700.01.02',
                                '1700.01.03' => '1-1700.01.03',
                                '1700.01.04' => '1-1700.01.04',
                                '1700.01.05' => '1-1700.01.05',
                                '1700.01.06' => '1-1700.01.06',
                                '1700.01.07' => '1-1700.01.07',
                                '1700.01.08' => '1-1700.01.08',
                                '1700.02' => '1-1700.02',
                                '1700.02.01' => '1-1700.02.01',
                                '1700.02.02' => '1-1700.02.02',
                                '1700.02.03' => '1-1700.02.03',
                                '1700.02.04' => '1-1700.02.04',
                                '1700.02.05' => '1-1700.02.05',
                                '1700.02.06' => '1-1700.02.06',
                                '1700.02.07' => '1-1700.02.07',
                                '1700.02.08' => '1-1700.02.08',
                                '1700.02.09' => '1-1700.02.09',
                                '1700.02.10' => '1-1700.02.10',
                                '1700.02.11' => '1-1700.02.11',
                                '1700.02.12' => '1-1700.02.12',
                                '1700.02.13' => '1-1700.02.13',
                                '1700.02.14' => '1-1700.02.14',
                                '1700.02.14.01' => '1-1700.02.14.01',
                                '1700.02.14.02' => '1-1700.02.14.02',
                                '1700.02.14.03' => '1-1700.02.14.03',
                                '1700.02.14.04' => '1-1700.02.14.04',
                                '1700.02.14.05' => '1-1700.02.14.05',
                                '1700.02.14.06' => '1-1700.02.14.06',
                                '1700.02.14.07' => '1-1700.02.14.07',
                                '1700.02.14.08' => '1-1700.02.14.08',
                                '1700.02.15' => '1-1700.02.15',
                                '1700.02.15.01' => '1-1700.02.15.01',
                                '1700.02.15.02' => '1-1700.02.15.02',
                                '1700.02.15.03' => '1-1700.02.15.03',
                                '1700.02.16' => '1-1700.02.16',
                                '1700.02.17' => '1-1700.02.17',
                                '1700.02.18' => '1-1700.02.18',
                                '1700.02.19' => '1-1700.02.19',
                                '1700.02.20' => '1-1700.02.20',
                                '1700.03' => '1-1700.03',
                                '1700.03.01' => '1-1700.03.01',
                                '1700.03.02' => '1-1700.03.02',
                                '1700.04' => '1-1700.04',
                                '1700.04.01' => '1-1700.04.01',
                                '1700.04.02' => '1-1700.04.02',
                                '1700.04.03' => '1-1700.04.03',
                                '1700.04.04' => '1-1700.04.04',
                                '1700.04.05' => '1-1700.04.05',
                                '1700.04.06' => '1-1700.04.06',
                                '1700.04.07' => '1-1700.04.07',
                                '1700.04.08' => '1-1700.04.08',
                                '1700.04.09' => '1-1700.04.09',
                                '1700.04.10' => '1-1700.04.10',
                                '1700.04.11' => '1-1700.04.11',
                                '1700.04.12' => '1-1700.04.12',
                                '1700.04.13' => '1-1700.04.13',
                                '1700.04.14' => '1-1700.04.14',
                                '1700.04.15' => '1-1700.04.15',
                                '1700.04.16' => '1-1700.04.16',
                                '1700.04.17' => '1-1700.04.17',
                                '1700.04.18' => '1-1700.04.18',
                                '1700.04.19' => '1-1700.04.19',
                                '1700.05' => '1-1700.05',
                                '1700.05.01' => '1-1700.05.01',
                                '1710' => '1-1710',
                                '1710.01' => '1-1710.01',
                                '1710.01.01' => '1-1710.01.01',
                                '1710.01.02' => '1-1710.01.02',
                                '1710.02' => '1-1710.02',
                                '1710.02.01' => '1-1710.02.01',
                                '1710.02.02' => '1-1710.02.02',
                                '1710.03' => '1-1710.03',
                                '1710.03.01' => '1-1710.03.01',
                                '1710.03.02' => '1-1710.03.02',
                                '1710.03.03' => '1-1710.03.03',
                                '1710.03.04' => '1-1710.03.04',
                                '1710.03.05' => '1-1710.03.05',
                                '1710.03.06' => '1-1710.03.06',
                                '1710.03.07' => '1-1710.03.07',
                                '1710.03.08' => '1-1710.03.08',
                                '1710.03.09' => '1-1710.03.09',
                                '1710.03.10' => '1-1710.03.10',
                                '1710.03.11' => '1-1710.03.11',
                                '1710.03.12' => '1-1710.03.12',
                                '1710.03.13' => '1-1710.03.13',
                                '1710.03.14' => '1-1710.03.14',
                                '1710.03.15' => '1-1710.03.15',
                                '1710.03.16' => '1-1710.03.16',
                                '1710.03.17' => '1-1710.03.17',
                                '1710.03.18' => '1-1710.03.18',
                                '1710.03.19' => '1-1710.03.19',
                                '1710.04' => '1-1710.04',
                                '2000.05' => '2-2000',
                                '2300' => '2-2300',
                                '2300.01' => '2-2300.01',
                                '2300.02' => '2-2300.02',
                                '2300.03' => '2-2300.03',
                                '2300.04' => '2-2300.04',
                                '2300.05' => '2-2300.05',
                                '2300.06' => '2-2300.06',
                                '2300.07' => '2-2300.07',
                                '2300.07.01' => '2-2300.07.01',
                                '2300.08' => '2-2300.08',
                                '2300.09' => '2-2300.09',
                                '2300.09.01' => '2-2300.09.01',
                                '2300.09.02' => '2-2300.09.02',
                                '2300.09.03' => '2-2300.09.03',
                                '2300.09.04' => '2-2300.09.04',
                                '2300.10' => '2-2300.10',
                                '2300.11' => '2-2300.11',
                                '2300.12' => '2-2300.12',
                                '2300.13' => '2-2300.13',
                                '310001' => '3-310001',
                                '320001' => '3-320001',
                                '4000' => '4-4000',
                                '4000.01' => '4-4000.01',
                                '4000.01.01' => '4-4000.01.01',
                                '4000.01.02' => '4-4000.01.02',
                                '4000.01.03' => '4-4000.01.03',
                                '4000.01.04' => '4-4000.01.04',
                                '4000.01.05' => '4-4000.01.05',
                                '4000.01.06' => '4-4000.01.06',
                                '4000.01.07' => '4-4000.01.07',
                                '4000.01.08' => '4-4000.01.08',
                                '4000.01.09' => '4-4000.01.09',
                                '4000.02' => '4-4000.02',
                                '4000.02.01' => '4-4000.02.01',
                                '4000.02.02' => '4-4000.02.02',
                                '4000.02.03' => '4-4000.02.03',
                                '4000.02.04' => '4-4000.02.04',
                                '4000.03' => '4-4000.03',
                                '4000.03.01' => '4-4000.03.01',
                                '4000.03.02' => '4-4000.03.02',
                                '4000.03.03' => '4-4000.03.03',
                                '4000.03.04' => '4-4000.03.04',
                                '4000.03.05' => '4-4000.03.05',
                                '4000.04' => '4-4000.04',
                                '4000.04.01' => '4-4000.04.01',
                                '4000.04.01.01' => '4-4000.04.01.01',
                                '4000.04.01.02' => '4-4000.04.01.02',
                                '4000.04.01.03' => '4-4000.04.01.03',
                                '4000.04.02' => '4-4000.04.02',
                                '4000.04.03' => '4-4000.04.03',
                                '4000.05' => '4-4000.05',
                                '4000.05.01' => '4-4000.05.01',
                                '4000.05.02' => '4-4000.05.02',
                                '4000.05.03' => '4-4000.05.03',
                                '4000.05.04' => '4-4000.05.04',
                                '4000.05.05' => '4-4000.05.05',
                                '4000.06' => '4-4000.06',
                                '4000.06.01' => '4-4000.06.01',
                                '6300' => '6-6300',
                                '6300.01' => '6-6300.01',
                                '6200' => '6-6200',
                                '6201' => '6-6201',
                                '6201.01' => '6-6201.01',
                                '6201.01.01' => '6-6201.01.01',
                                '6201.02' => '6-6201.02',
                                '6201.02.01' => '6-6201.02.01',
                                '6201.02.02' => '6-6201.02.02',
                                '6201.02.03' => '6-6201.02.03',
                                '6202' => '6-6202',
                                '6202.01' => '6-6202.01',
                                '6202.02' => '6-6202.02',
                                '6202.03' => '6-6202.03',
                                '6202.04' => '6-6202.04',
                                '6202.05' => '6-6202.05',
                                '6203' => '6-6203',
                                '6203.01' => '6-6203.01',
                                '6203.02' => '6-6203.02',
                                '6203.03' => '6-6203.03',
                                '6203.04' => '6-6203.04',
                                '6203.04.01' => '6-6203.04.01',
                                '6203.04.02' => '6-6203.04.02',
                                '6203.04.03' => '6-6203.04.03',
                                '6203.04.04' => '6-6203.04.04',
                                '6203.04.05' => '6-6203.04.05',
                                '6203.04.06' => '6-6203.04.06',
                                '6203.04.07' => '6-6203.04.07',
                                '6203.04.08' => '6-6203.04.08',
                                '6203.05' => '6-6203.05',
                                '6204' => '6-6204',
                                '6204.01' => '6-6204.01',
                                '6204.02' => '6-6204.02',
                                '6204.03' => '6-6204.03',
                                '6204.04' => '6-6204.04',
                                '6204.05' => '6-6204.05',
                                '6204.06' => '6-6204.06',
                                '6204.07' => '6-6204.07',
                                '6204.08' => '6-6204.08',
                                '6204.09' => '6-6204.09',
                                '6205' => '6-6205',
                                '6205.01' => '6-6205.01',
                                '6205.02' => '6-6205.02',
                                '6206' => '6-6206',
                                '6206.01' => '6-6206.01',
                                '6206.02' => '6-6206.02',
                                '6206.03' => '6-6206.03',
                                '6206.04' => '6-6206.04',
                                '6206.05' => '6-6206.05',
                                '6206.06' => '6-6206.06',
                                '6207' => '6-6207',
                                '6207.01' => '6-6207.01',
                                '6207.02' => '6-6207.02',
                                '6207.02.01' => '6-6207.02.01',
                                '6207.02.02' => '6-6207.02.02',
                                '6207.02.03' => '6-6207.02.03',
                                '6207.02.04' => '6-6207.02.04',
                                '6207.02.05' => '6-6207.02.05',
                                '6208' => '6-6208',
                                '6208.02' => '6-6208.02',
                                '6208.03' => '6-6208.03',
                                '6208.03.01' => '6-6208.03.01',
                                '6208.03.02' => '6-6208.03.02',
                                '6208.03.03' => '6-6208.03.03',
                                '6208.03.04' => '6-6208.03.04',
                                '6208.03.05' => '6-6208.03.05',
                                '6208.03.06' => '6-6208.03.06',
                                '6208.03.07' => '6-6208.03.07',
                                '6208.03.08' => '6-6208.03.08',
                                '6208.03.09' => '6-6208.03.09',
                                '6208.03.10' => '6-6208.03.10',
                                '6208.03.11' => '6-6208.03.11',
                                '6208.03.12' => '6-6208.03.12',
                                '6208.03.13' => '6-6208.03.13',
                                '6208.03.14' => '6-6208.03.14',
                                '6208.03.15' => '6-6208.03.15',
                                '6208.03.16' => '6-6208.03.16',
                                '6208.03.17' => '6-6208.03.17',
                                '6208.03.18' => '6-6208.03.18',
                                '6208.04' => '6-6208.04',
                                '6208.05' => '6-6208.05',
                                '6208.06' => '6-6208.06',
                                '6208.07' => '6-6208.07',
                                '6208.07.01' => '6-6208.07.01',
                                '6208.07.02' => '6-6208.07.02',
                                '6208.07.03' => '6-6208.07.03',
                                '6208.07.04' => '6-6208.07.04',
                                '6208.07.05' => '6-6208.07.05',
                                '6208.07.06' => '6-6208.07.06',
                                '6208.07.07' => '6-6208.07.07',
                                '6208.08' => '6-6208.08',
                                '6209' => '6-6209',
                                '6210' => '6-6210',
                                '6210.01' => '6-6210.01',
                                '6210.02' => '6-6210.02',
                                '6211' => '6-6211',
                                '6211.01' => '6-6211.01',
                                '6211.02' => '6-6211.02',
                                '6211.03' => '6-6211.03',
                                '6211.04' => '6-6211.04',
                                '6211.05' => '6-6211.05',
                                '6213' => '6-6213',
                                '6213.01' => '6-6213.01',
                                '6213.01.01' => '6-6213.01.01',
                                '6213.01.02' => '6-6213.01.02',
                                '6213.01.03' => '6-6213.01.03',
                                '6213.01.04' => '6-6213.01.04',
                                '6213.01.05' => '6-6213.01.05',
                                '6213.01.06' => '6-6213.01.06',
                                '6213.02' => '6-6213.02',
                                '6213.02.01' => '6-6213.02.01',
                                '6213.02.02' => '6-6213.02.02',
                                '6213.02.03' => '6-6213.02.03',
                                '6213.02.04' => '6-6213.02.04',
                                '6213.02.05' => '6-6213.02.05',
                                '6213.02.06' => '6-6213.02.06',
                                '6213.02.07' => '6-6213.02.07',
                                '6213.03' => '6-6213.03',
                                '6213.03.01' => '6-6213.03.01',
                                '6213.03.02' => '6-6213.03.02',
                                '6213.03.03' => '6-6213.03.03',
                                '6213.04' => '6-6213.04',
                                '6213.04.01' => '6-6213.04.01',
                                '6213.04.02' => '6-6213.04.02',
                                '6213.04.03' => '6-6213.04.03',
                                '6213.04.04' => '6-6213.04.04',
                                '6213.04.05' => '6-6213.04.05',
                                '6213.04.06' => '6-6213.04.06',
                                '6213.04.07' => '6-6213.04.07',
                                '6213.04.08' => '6-6213.04.08',
                                '6213.04.09' => '6-6213.04.09',
                                '6213.05' => '6-6213.05',
                                '6213.05.01' => '6-6213.05.01',
                                '6213.05.02' => '6-6213.05.02',
                                '6214' => '6-6214',
                                '6214.01' => '6-6214.01',
                                '6214.01.01' => '6-6214.01.01',
                                '6214.01.02' => '6-6214.01.02',
                                '6214.01.03' => '6-6214.01.03',
                                '6214.02' => '6-6214.02',
                                '6214.02.01' => '6-6214.02.01',
                                '6214.02.02' => '6-6214.02.02',
                                '6214.02.03' => '6-6214.02.03',
                                '6214.03' => '6-6214.03',
                                '6214.03.01' => '6-6214.03.01',
                                '6214.03.02' => '6-6214.03.02',
                                '6214.04' => '6-6214.04',
                                '6214.04.01' => '6-6214.04.01',
                                '6214.04.01.01' => '6-6214.04.01.01',
                                '6214.04.01.02' => '6-6214.04.01.02',
                                '6214.04.01.03' => '6-6214.04.01.03',
                                '6214.04.01.04' => '6-6214.04.01.04',
                                '6214.04.01.05' => '6-6214.04.01.05',
                                '6214.04.01.06' => '6-6214.04.01.06',
                                '6214.04.01.07' => '6-6214.04.01.07',
                                '6214.04.01.08' => '6-6214.04.01.08',
                                '6214.04.01.09' => '6-6214.04.01.09',
                                '6214.04.01.10' => '6-6214.04.01.10',
                                '6214.04.02' => '6-6214.04.02',
                                '6214.04.02.01' => '6-6214.04.02.01',
                                '6214.04.02.02' => '6-6214.04.02.02',
                                '6214.04.02.03' => '6-6214.04.02.03',
                                '6214.04.02.04' => '6-6214.04.02.04',
                                '6214.04.02.05' => '6-6214.04.02.05',
                                '6214.04.02.06' => '6-6214.04.02.06',
                                '6214.04.02.07' => '6-6214.04.02.07',
                                '6214.04.02.08' => '6-6214.04.02.08',
                                '6214.05' => '6-6214.05',
                                '6214.05.01' => '6-6214.05.01',
                                '6214.05.02' => '6-6214.05.02',
                                '6214.05.03' => '6-6214.05.03',
                                '6214.05.04' => '6-6214.05.04',
                                '6214.05.05' => '6-6214.05.05',
                                '6214.06' => '6-6214.06',
                                '6214.06.01' => '6-6214.06.01',
                                '6214.06.02' => '6-6214.06.02',
                                '6214.06.03' => '6-6214.06.03',
                                '6214.06.04' => '6-6214.06.04',
                                '6215' => '6-6215',
                                '6215.01' => '6-6215.01',
                                '6215.01.01' => '6-6215.01.01',
                                '6215.01.02' => '6-6215.01.02',
                                '6215.01.03' => '6-6215.01.03',
                                '6215.01.04' => '6-6215.01.04',
                                '6215.01.05' => '6-6215.01.05',
                                '6216' => '6-6216',
                                '6216.01' => '6-6216.01',
                                '6216.01.01' => '6-6216.01.01',
                                '6217' => '6-6217',
                                '6217.01' => '6-6217.01',
                                '6217.02' => '6-6217.02',
                                '6217.03' => '6-6217.03',
                                '6217.04' => '6-6217.04',
                                '6217.05' => '6-6217.05',
                                '6217.06' => '6-6217.06',
                                '6217.07' => '6-6217.07',
                                '6218' => '6-6218',
                                '6218.01' => '6-6218.01',
                                '6218.02' => '6-6218.02',
                                '6218.03' => '6-6218.03',
                                '6218.04' => '6-6218.04',
                                '6218.05' => '6-6218.05',
                                '6219' => '6-6219',
                                '6219.01' => '6-6219.01',
                                '6219.01.01' => '6-6219.01.01',
                                '6219.01.02' => '6-6219.01.02',
                                '6219.01.03' => '6-6219.01.03',
                                '6219.02' => '6-6219.02',
                                '6219.02.01' => '6-6219.02.01',
                                '6219.02.02' => '6-6219.02.02',
                                '6219.03' => '6-6219.03',
                                '6219.04' => '6-6219.04',
                                '6219.05' => '6-6219.05',
                                '6219.05.01' => '6-6219.05.01',
                                '6219.05.01.01' => '6-6219.05.01.01',
                                '6219.05.01.02' => '6-6219.05.01.02',
                                '6219.05.02' => '6-6219.05.02',
                                '6219.05.02.01' => '6-6219.05.02.01',
                                '6219.05.02.02' => '6-6219.05.02.02',
                                '6220' => '6-6220',
                                '6220.01' => '6-6220.01',
                                '6220.02' => '6-6220.02',
                                '6220.03' => '6-6220.03',
                                '6221' => '6-6221',
                                '6221.01' => '6-6221.01',
                                '6221.02' => '6-6221.02',
                                '6221.03' => '6-6221.03',
                                '6222' => '6-6222',
                                '6222.01' => '6-6222.01',
                                '6223' => '6-6223',
                                '6223.01' => '6-6223.01',
                                '6224' => '6-6224',
                                '6224.01' => '6-6224.01',
                                '6224.02' => '6-6224.02',
                                '6224.03' => '6-6224.03',
                                '6224.04' => '6-6224.04',
                                '6224.04.01' => '6-6224.04.01',
                                '6224.04.02' => '6-6224.04.02',
                                '6225' => '6-6225',
                                '6225.01' => '6-6225.01',
                                '6225.02' => '6-6225.02',
                                '6226' => '6-6226',
                                '6226.01' => '6-6226.01',
                                '6227' => '6-6227',
                                '6227.01' => '6-6227.01',
                                '6228' => '6-6228',
                                '6228.01' => '6-6228.01',
                                '6400' => '6-6400',
                                '6400.01' => '6-6400.01',
                                '6400.02' => '6-6400.02',
                                '6400.03' => '6-6400.03',
                                '6400.04' => '6-6400.04',
                                '6400.05' => '6-6400.05',
                                '7100' => '7-7100',
                                '7100.01' => '7-7100.01',
                                '7100.02' => '7-7100.02',
                                '7100.03' => '7-7100.03',
                                '7200' => '7-7200',
                                '7200.01' => '7-7200.01',
                                '7200.02' => '7-7200.02',
                                '7200.03' => '7-7200.03',
                            ];

                            // Pemetaan kode akun
                            $accountNoOri = $journal['GLACCOUNT'];
                            $hasChanged = false;
                    
                            if (isset($accountMapping[$accountNoOri])) {
                                $journal['GLACCOUNT'] = $accountMapping[$accountNoOri];
                                $hasChanged = true;
                            }
                    
                            // Tambahkan detail ke jurnal terkait
                            $groupedJournals[$JVNUMBER]['journaldetail'][] = [
                                'accountNo' => $journal['GLACCOUNT'],
                                'accountOri' => $accountNoOri,
                                'amount' => (double)(str_replace('-', '', $journal['GLAMOUNT'])),
                                'amountType' => isset($journal['SEQ']) && $journal['SEQ'] == 1 ? 'CREDIT' : 'DEBIT',
                                'memo' => $journal['DESCRIPTION'],
                                // 'vendorNo' => ($journal['SUBSIDIARY'] == 2 && isset($accountMapping[$journal['GLACCOUNT']]) && $accountMapping[$journal['GLACCOUNT']] == '2-2000')  
                                // ? '1000'  
                                // : (!empty($journal['SUBSIDIARY']) ? (string) $journal['SUBSIDIARY'] : "0")
                                'vendorNo' => ($journal['SUBSIDIARY'] == 2 && $accountNoOri == '2000.05')  
                                ? '1000' : (!empty($journal['SUBSIDIARY']) ? (string) $journal['SUBSIDIARY'] : "")
                            ];
                    
                            // Simpan detail di database DetailCompare
                            $detailCompare = new DetailCompare();
                            $detailCompare->number = $JVNUMBER;
                            $detailCompare->transDate = date('Y-m-d', strtotime($journal['TRANSDATE']));
                            $detailCompare->accountNo = $journal['GLACCOUNT'];
                            $detailCompare->accountOri = $accountNoOri;
                            $detailCompare->amount = (double)(str_replace('-', '', $journal['GLAMOUNT']));
                            $detailCompare->amountType = isset($journal['SEQ']) && $journal['SEQ'] == 1 ? 'CREDIT' : 'DEBIT';
                            $detailCompare->memo = $journal['DESCRIPTION'];
                            $detailCompare->vendorNo = ($journal['SUBSIDIARY'] == 2 && $accountNoOri == '2000.05')  
                            ? '1000' : (!empty($journal['SUBSIDIARY']) ? (string) $journal['SUBSIDIARY'] : "");
                            $detailCompare->save();
                        }

                        // Konversi array detail menjadi daftar yang bersih
                        foreach ($groupedJournals as $JVNUMBER => &$journal) {
                            $journal['journaldetail'] = array_values($journal['journaldetail']);
                        }
                    
                        // Simpan ke sesi untuk diproses lebih lanjut
                        Yii::$app->session->set('importJournalFromJson', array_values($groupedJournals));
                        Yii::$app->session->setFlash('success', "Files successfully uploaded and processed.");
                        return $this->redirect(['journal-index']);
                        // return $this->redirect(['sendjournalapi']);
                        // echo "<pre>";
                            // print_r($filteredData);
                            // echo "</pre>";
                            // exit;
                        // Render view untuk menampilkan tabel atau cek hasil
                            // return $this->render('jsonuploadjournaltable', [
                            //     'filteredData' => $filteredData,
                            // ]);
                    }
                     else {
                        Yii::$app->session->setFlash('error', 'Invalid JSON format.');
                    }
                } else {
                    Yii::$app->session->setFlash('error', 'Failed to save uploaded files.');
                }

                return $this->refresh();
            }
        }

        return $this->render('jsonuploadjurnalindex', [
            'model' => $model,
        ]);
    }

    //kalo send satu, perlu set id di parameter
    public function actionSendapi() 
    {
        // $selectedIds = Yii::$app->request->post('selection', []); 
        // $accounts = Accounts::findAll($selectedIds);
        $accounts = Yii::$app->session->get('importAccountFromJson', []);

        Yii::$app->session->set('accountData', $accounts);
        Yii::$app->session->set('inputScope', 'glaccount_save');

        return $this->redirect(['accurate/authorize']);
    }
    public function actionSendjournalapi() 
    {
        // var_dump("masuk");die;
        $selectedIds = Yii::$app->request->post('selection', []);
        $journals = JournalCompare::find()->andWhere(['in', 'id', $selectedIds])->asArray()->all();
        
        // foreach ($journals as $journalprint) {
        //     echo "<pre>";
        //     var_dump($journalprint); 
        //     echo "</pre>";
        // }
        // exit; 

        //ini kalo cara lama
        // $journals = Yii::$app->session->get('importJournalFromJson', []);

        // Siapkan struktur data untuk API
        $formattedData = [];
        foreach ($journals as $journal) {
            $number = $journal['number'];
            $journalData = [
                'number' => $journal['number'],
                'transDate' => $journal['transDate'],
                'description' => $journal['description'],
                'branchName' => $journal['branchName'],
                // 'id' => 1755270,
                'detailJournalVoucher' => [],
            ];
            
            $details = DetailCompare::find()->where(['number' => $number])->all();
            // Tambahkan detail jurnal
            foreach ($details as $detail) {
                $journalData['detailJournalVoucher'][] = [
                    'accountNo' => $detail->accountNo, 
                    'amount' => $detail->amount,
                    'amountType' => $detail->amountType,
                    'memo' => $detail->memo, 
                    'vendorNo' => $detail->vendorNo, 
                ];
            }

            $formattedData[] = $journalData;
        }

        // echo "<pre>";
        // var_dump($formattedData); 
        // echo "</pre>";
        // exit;
        
        Yii::$app->session->set('journalData', $formattedData);
        Yii::$app->session->set('inputScope', "journal_voucher_save");
        
        return $this->redirect(['accurate/authorize', 'batchIndex' => 0]);
    }

    public function actionDeletealljournalapi() 
    {
        // var_dump('masuk');die;
        $ids = range(1, 99);
        Yii::$app->session->set('deleteJournalData', $ids);
        Yii::$app->session->set('inputScope', 'journal_voucher_delete');

        return $this->redirect(['accurate/authorize']);
    }
    
    public function actionSendaccountstoaol() //ini ke database XD
    {
        // Ambil data dari session yang disimpan sebelumnya
        $importedAccounts = Yii::$app->session->get('importAccountFromJson', []);
        // var_dump($importedAccounts); die;
        
        if (empty($importedAccounts)) {
            Yii::$app->session->setFlash('error', 'Tidak ada data yang tersedia untuk diimpor.');
            return $this->redirect(['jsonuploadindex']);
        }
        
        try {
            foreach ($importedAccounts as $accountData) {
                $account = new Accounts();
                
                $data = [
                    'accountType' => $accountData['accountType'],
                    'asOf' => $accountData['asOf'],
                    'currencyCode' => $accountData['currencyCode'],
                    'name' => $accountData['name'],
                    'no' => $accountData['no'],
                    'parentNo' => $accountData['parentNo'],
                    'memo' => $accountData['memo'],
                ];

                $account->attributes = $data;
                $account->save();
            }
            
            // Menampilkan pesan sukses
            Yii::$app->session->setFlash('success', 'Akun berhasil masuk ke database!');
        } catch (\Exception $e) {
            // Jika terjadi error, batalkan transaksi dan tampilkan pesan error
            Yii::$app->session->setFlash('error', 'Terjadi kesalahan: ' . $e->getMessage());
        }

        return $this->redirect(['api/index']);
    }
    
    public function actionSendjournalstoaol() //ini ke database XD
    {
        $importedJournals = Yii::$app->session->get('importJournalFromJson', []);
        
        if (empty($importedJournals)) {
            Yii::$app->session->setFlash('error', 'Tidak ada data yang tersedia untuk diimpor.');
            return $this->redirect(['jsonuploadindex']);
        }
        
        try {
            foreach ($importedJournals as $journalData) {
                // Buat model baru untuk setiap account
                $journal = new Journal();
                
                $data = [
                    'number' => $journalData['number'],
                    'transDate' => $journalData['transDate'],
                    'description' => $journalData['description'],
                    'accountNo' => $journalData['accountNo'],
                    'amount' => $journalData['amount'],
                    'amountType' => $journalData['amountType'],
                    'memo' => $journalData['memo'],
                ];

                $journal->attributes = $data;
                $journal->save();
            }
            
            // Menampilkan pesan sukses
            Yii::$app->session->setFlash('success', 'Jurnal berhasil masuk ke database!');
        } catch (\Exception $e) {
            // Jika terjadi error, batalkan transaksi dan tampilkan pesan error
            Yii::$app->session->setFlash('error', 'Terjadi kesalahan: ' . $e->getMessage());
        }

        // Redirect ke halaman lain setelah proses selesai
        return $this->redirect(['api/journal-index']);
    }
    public function actionFilldatabasewithjournal(){
        for ($jurnal=1; $jurnal<=51000; $jurnal++){
            //simpan dulu journal numbernya
            $journalNumber = sprintf("TEST%05d", $jurnal);
            //randomize tanggal
            $startDate = strtotime('2016-01-01');
            $endDate = time(); // Waktu sekarang
            $randomTimestamp = mt_rand($startDate, $endDate);

            $journalCompare = new JournalCompare();
            $journalCompare->number = $journalNumber; 
            $journalCompare->trans_date = date('d/m/Y', $randomTimestamp);
            $branchNames = ["Yayasan SAAT", "STT SAAT"];
            $journalCompare->branchName = $branchNames[array_rand($branchNames)];
            $journalCompare->save();

            $accountRandom = [            
                '1000',
                '1001',
                '1001.01',
                '1001.02',
                '1001.03', //pindah
                '1001.04',
                '1001.05', //pindah
                '1001.06',
                '1001.07', //pindah
                '1001.08',
            ];
            $accountNoOri = $accountRandom[array_rand($accountRandom)];
                    
            //pemetaan belum dipake
            $accountMapping = [            
                '1000' => '1-1000',
                '1001' => '1-1001',
                '1001.01' => '1-1001.01',
                '1001.02' => '1-1001.02',
                '1001.03' => '1-1001.02', //pindah
                '1001.04' => '1-1001.03',
                '1001.05' => '1-1001.02', //pindah
                '1001.06' => '1-1001.04',
                '1001.07' => '1-1001.02', //pindah
                '1001.08' => '1-1001.05',
            ];
            if (isset($accountMapping[$accountNoOri])) {
                $accountMap = $accountMapping[$accountNoOri];
            }
            
            $jumlah_kredit = 0;
            for($detail=1; $detail<50; $detail++) {
                //masukkan debit dulu
                $jumlah_debit = mt_rand(1000, 5000);
                $jumlah_kredit += $jumlah_debit;

                $detailCompare = new DetailCompare();
                $detailCompare->number = $journalNumber;
                $detailCompare->trans_date = date('Y-m-d', $randomTimestamp); 
                $detailCompare->account_ori = $accountNoOri;
                $detailCompare->amount = $jumlah_debit;
                $detailCompare->amount_type = 'DEBIT';
                $detailCompare->save();
            }

            //masukkan kreditnya
            $detailCompare = new DetailCompare();
            $detailCompare->number = $journalNumber;
            $detailCompare->trans_date = date('Y-m-d', $randomTimestamp); 
            $detailCompare->account_ori = $accountNoOri;
            $detailCompare->amount = $jumlah_kredit;
            $detailCompare->amount_type = 'CREDIT';
            $detailCompare->save();
        }
    }
}

